---
title: "MSF_Groupwork-NBA_shotlog" 
author: "Team_9"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
<<<<<<< HEAD
Report produced by: Justin Leiendecker, Alexander Romanenko, Artmeis Tomadaki-Balomenou, Zijun Wei, Reza Widodo  
Date submitted: 16/10/2016

#Report structure 

###Introduction/Summary

The purpose of this report is to analyse a chosen dataset and to produce meaningful results using statistical and mathematical analysis. These analyses have been conducted using RStudio software. This report will focus on analysis of a number of areas, demonstrate how the analysis has been conducted (including 'clean-up' of the data), discuss theory used, demonstrate and evaluate produced results. In addition, this report will highlight potential areas of future research. 

The chosen dataset for this report is a summary of shots made during NBA season 2015-2016. The following areas of research have been selected:

###TO BE UPDATED when we know final areas
=======

a. Hot Hand Theory (Artemis)
b. Defender Proximity Analysis (Reza)
c. Shot Clock Pressure  (Alex)
d. Close Game Effect - Small Margin affecting the scoring rate 
e. Home Advantage (Alex is working in this point)  
f. Fatigue Effect (Quarter Heat Rate)  
g. Shooting Percentage (James)
h. Fatigue Effect (Number of Rest Day)  
i. Regression Analysis (Alex)

##Theory
I   What do you expect to find?
a. 

##Methods
I   Describe the dataset:
  
    Data on shots taken during the 2014-2015 season, who took the shot, where on the floor was the shot taken from, who was the nearest defender, how far away was the nearest defender, time on the shot clock, and much more. The column titles are generally self-explanatory.
Useful for evaluating who the best shooter is, who the best defender is, the hot-hand hypothesis, etc.
Scraped from NBA's REST API.  It has 128,609 rows and 22 columns with 16 MB data size. ##TO BE UPDATED FURTHER

I   Strengths
    
    The dataset comprise of comprehensive observational data to start to work with. 

I   Limitations
    The dataset consists only for 1 year NBA season with regular match (82 matches per team for both home and away matches). The playoff and other matches during the year is not included.

##Analysis

### Installing libraries

During the research the following librares have been installed:
```{r}
install.packages('reshape')

```


### Calling libraries

During the research the following libraries have been used:
```{r}
library(reshape)
library(ggplot2)

```


###Data clean-up 
This section describes exercises that had to be performed in order to prepare the raw data for the required analysis. 

```{r}
df<- read.csv("shot_logs.csv")  #assigning the dataframe to 'df' variables
attach(df) #telling R that this is the dataframe we'll be working with (eliminating the need to use df$ for variables)

df1<- read.csv("shot_logs1010.csv")

#we need to change the format of some of the columns to 'Character'
#get rid off 'attach()'
#get rid off column X in shot logs1010 file

```

For convenience of using the report, the 'post data clean-up' csv file have been produced.
**add 'latest'clean CSV file**

### Home Advantage analysis

```{r}
# replacing W/L in column "W" with 1/0 (1 for win, 0 for loss)
df[,"W"] <- as.character(df[,"W"])

for (i in 1:nrow(df)) {
  if (df[i,"W"]=="W") df[i,"W"]<- 1
  if (df[i,"W"]=="L") df[i,"W"]<- 0}

df[,"W"] <- as.numeric(df[,"W"])
```

```{r}
#adding columns for names of 'home' and 'away' teams. In addition, WINNER column tells which team won
df[,"MATCHUP"] <- as.character(df[,"MATCHUP"])
df[,"W"] <- as.character(df[,"W"])

for (i in 1:nrow(df)) {
  if (LOCATION[i]=="H") {df$HOME_TEAM [i] <- unlist(strsplit(df$MATCHUP[i]," "))[5]
  df$AWAY_TEAM [i] <- unlist(strsplit(df$MATCHUP[i]," "))[7]
  if (W[i]=="W") df$WINNER[i] <- "HOME" 
  if (W[i]=="L") df$WINNER[i] <- "AWAY"}
  if (LOCATION[i]=="A") {df$HOME_TEAM [i] <- unlist(strsplit(df$MATCHUP[i]," "))[7] 
  df$AWAY_TEAM [i] <- unlist(strsplit(df$MATCHUP[i]," "))[5]
  if (W[i]=="L") df$WINNER[i] <- "HOME"  
  if (W[i]=="W") df$WINNER[i] <- "AWAY"}}

df$BLANK<-"" #for some reason cast function does not work with last column in dataframe, so I have created this BLANK column as I need to use AWAY_TEAM colum (it was a last column). 
```

```{r}
aa<- cast(df1, GAME_ID1 + HOME_TEAM + AWAY_TEAM + WINNER ~ W)

table(aa$WINNER) 
#home wins:
hh<-sum(aa$WINNER=="HOME")
#Away wins:
aw<-sum(aa$WINNER=="AWAY")
#percentage of home team winning: 
round(hh/(hh+aw),2)
round(aw/(hh+aw),2)
```

```{r}

aa1<- cast(aa, HOME_TEAM  ~ WINNER); names(aa1)[1]<-"TEAM"
aa1$WIN_PCT_HOME<-round(aa1$HOME/(aa1$HOME+aa1$AWAY),2)

aa2<- cast(aa, AWAY_TEAM ~ WINNER); names(aa2)[1]<-"TEAM"
aa2$WIN_PCT_AWAY<-round(aa2$AWAY/(aa2$HOME+aa2$AWAY),2)

aa3<- merge (aa1,aa2, by ="TEAM")


for (i in 1:nrow(aa3)) {if(aa3$WIN_PCT_HOME[i]>aa3$WIN_PCT_AWAY[i]) aa3$HOME_ADV[i]<-"YES" else aa3$HOME_ADV[i]<-"NO"}
head(aa3)

aa3<- aa3[order(aa3$WIN_PCT_HOME,decreasing=TRUE),]
rownames(aa4)<-NULL

aa3$TEAM <- factor(aa3$TEAM, levels = aa3$TEAM[order(-aa3$WIN_PCT_HOME)])


ggplot(aa3,aes(x=TEAM)) + geom_point(aes(y= WIN_PCT_HOME, col= "HOME"))+ geom_point(aes( y= WIN_PCT_AWAY, col= "AWAY")) 

```

#Close Game Effect (Justin)

```{r}
# create new variable to seperate overtime

df[, "OVERTIME"] <- as.numeric()

for (i in 1:nrow(df)) {
  if (df[i, "PERIOD"] >= 5) df[i, "OVERTIME"] <- 1
  if (df[i, "PERIOD"] <= 4) df[i, "OVERTIME"] <- 0
}

# accuracy 
acc_ot <- as.numeric
acc_ot <- sum(df$OVERTIME == 1 & df$FGM == 1)/sum(df$OVERTIME == 1)

acc_qrt1 <- as.numeric
acc_qrt1 <- sum(df$PERIOD == 1 & df$FGM == 1)/sum(df$PERIOD == 1)

acc_qrt2 <- as.numeric
acc_qrt2 <- sum(df$PERIOD == 2 & df$FGM == 1)/sum(df$PERIOD == 2)

acc_qrt3 <- as.numeric
acc_qrt3 <- sum(df$PERIOD == 3 & df$FGM == 1)/sum(df$PERIOD == 3)

acc_qrt4 <- as.numeric
acc_qrt4 <- sum(df$PERIOD == 4 & df$FGM == 1)/sum(df$PERIOD == 4)

acc_qrt5 <- as.numeric
acc_qrt5 <- sum(df$PERIOD == 5 & df$FGM == 1)/sum(df$PERIOD == 5)

acc_qrt6 <- as.numeric
acc_qrt6 <- sum(df$PERIOD == 6 & df$FGM == 1)/sum(df$PERIOD == 6)

acc_qrt7 <- as.numeric
acc_qrt7 <- sum(df$PERIOD == 7 & df$FGM == 1)/sum(df$PERIOD == 7)

acc_qrt1_4 <- as.numeric
acc_qrt1_4 <- sum(df$PERIOD <= 4 & df$FGM == 1) / sum(df$PERIOD <= 4)

t.test(df$FGM[df$PERIOD <= 4], df$FGM[df$PERIOD >= 5])
t.test(df$FGM[df$PERIOD == 1], df$FGM[df$PERIOD == 2])
t.test(df$FGM[df$PERIOD == 2], df$FGM[df$PERIOD == 3])
t.test(df$FGM[df$PERIOD == 3], df$FGM[df$PERIOD == 4])
t.test(df$FGM[df$PERIOD == 1], df$FGM[df$PERIOD == 3])
t.test(df$FGM[df$PERIOD == 2], df$FGM[df$PERIOD == 4])

# accuracy for Top 10 scoring players




# accuracy for Shot Clock

  # dealing with missing values
df[is.na(df)] <- 99

acc <- data.frame()
acc[, "SECONDS_LEFT"] <- c(1:23)

#accuracy for every second
for (i in 1:23){
  acc[i, "Accuracy"] <- (sum(df$SHOT_CLOCK > i & df$SHOT_CLOCK <= i+1 & df$SHOT_CLOCK != 99 & df$FGM == 1)/ sum(df$SHOT_CLOCK > i & df$SHOT_CLOCK <= i+1 & df$SHOT_CLOCK != 99))}

ggplot(acc, aes(x = SECONDS_LEFT, y = Accuracy)) + geom_point() + geom_smooth()

df[, "ACC_P_SEC"] <- as.numeric()

#Assign accuracy per second to main dataframe
for (i in 1:nrow(df)){
  for (j in 1:23){
    if (df$SHOT_CLOCK[i] >j & df$SHOT_CLOCK[i] <= j+1 & df$SHOT_CLOCK[i] != 99) df[i, "ACC_P_SEC"] <- acc[j, "Accuracy"]
  }
}


cov(df$ACC_P_SEC, df$SHOT_CLOCK)
cor.test(df$ACC_P_SEC, df$SHOT_CLOCK)




```




# Shooting Percentage Analysis (James)

```{r}
# Replace "made" and "missed" with 1 and 0 respectively

df[, "SHOT_RESULT"] <- as.character(df[, "SHOT_RESULT"])
 
for (i in 1:nrow(df)) {
  if (df[i, "SHOT_RESULT"] == "made") df[i, "SHOT_RESULT"] <- 1
  if (df[i, "SHOT_RESULT"] == "missed") df[i, "SHOT_RESULT"] <- 0
}

df[, "SHOT_RESULT"] <- as.numeric(df[, "SHOT_RESULT"])

```

# Find shooting percentage of each match

```{r}
# Reshape the dataframe

game <- cast(data = df, GAME_ID1 + HOME_TEAM + AWAY_TEAM + LOCATION + player_name + W ~ FGM)

# Field Goal Attempts

game[, "FGA"] <- NA
for(i in 1:nrow(game)){
  game[i, "FGA"] <- game[i, "1"] + game[i, "0"]
}

# Find Feild Goal Percentage of each indivudual player in that match

game[, "FG.percentage"] <- NA 
for (i in 1:nrow(game)){
  game[i, "FG.percentage"] <- round(((game[i, "1"]/game[i, "FGA"]) * 100), digits = 2)
}
```

# Impact of Super Star Players

```{r}

# Pick out 8 of the best players in that regular season and create a new subset. Analyse how shooting percentage of these players can influence the result of a match.

super.star.list <- c("lebron james", "james harden", "russell westbrook", "stephen curry", "anthony davis", "blake griffin", "klay thompson", "lamarcus aldridge") # players picked out
super.star <- game[game$player_name %in% super.star.list, c("player_name", "W", "FGA", "FG.percentage")] # create a subset for these players

ggplot(super.star) + geom_boxplot(aes(x = player_name, y = FGA, colour = W))
ggplot(super.star) + geom_boxplot(aes(x = player_name, y = FG.percentage, colour = W))

# Replace "W" and "L" with 1 and 0 respectively, 
super.star[, "W"] <- as.character(super.star[, "W"])
for (i in 1:nrow(super.star)) {
  if (super.star[i, "W"] == "W") super.star[i, "W"] <- 1
  if (super.star[i, "W"] == "L") super.star[i, "W"] <- 0
}
super.star[, "W"] <- as.numeric(super.star[, "W"])

# Correlation test
t.test(super.star[, "W"], super.star[, "FGA"]) # this makes no sense...

# Linear regression
summary(lm(W ~ player_name + FGA, data = super.star))
summary(lm(W ~ player_name + FG.percentage, data = super.star))

```


###Defender Proximity Analysis
```{r}
#Data Preparation
#Change the value of shot result column to numeric
df[, "SHOT_RESULT"] <- as.character(df[, "SHOT_RESULT"])
for (j in 1:nrow(df)){
  df[j, "SHOT_RESULT"] <- ifelse (df[j, "SHOT_RESULT"] == "made", 1, 0)
}

#set the value to numeric or integer accordingly
df[, "SHOT_RESULT"] <- as.numeric(df[, "SHOT_RESULT"])
df[, "PTS_TYPE"] <- as.integer(df[, "PTS_TYPE"])
df[, "CLOSE_DEF_DIS"] <- as.numeric(df[, "CLOSE_DEF_DIST"])

#select data with only scored result
#Point type (2 or 3 points) and distance
point_type <- c()
distance <- c()
for (z in 1:nrow(df)){
  if(df[z, "SHOT_RESULT"] == 1 & df[z, "PTS_TYPE"] >= 1){
    point_type <- c(point_type, df[z, "PTS_TYPE"])
    distance <- c(distance, df[z, "CLOSE_DEF_DIST"])
  }
}

#combine point type and distance
valid_distance = data.frame(point_type, distance)

#calculate correlation between defender distance and points made (2 or 3 points)
cor(point_type, distance)

#plot the diagram for this correlation
library(ggplot2)
ggplot(data = valid_distance, aes(x = point_type, y = distance, group = point_type)) + 
  geom_boxplot() + stat_summary(fun.y = mean, geom = "point", shape = 5, size = 1) + 
  ggtitle("Points Scored based on Distance from Defender")

#calculate correlation between defender distance and shot result
cor(df[, "SHOT_RESULT"], df[, "CLOSE_DEF_DIS"])

#--------------------------------------------------------------------------------#

#Further analysis
#select distance data from 2 points shot scored and the players who scored it
distance2 <- c()
players2 <- c()
for (z in 1:nrow(df)){
  if(df[z, "SHOT_RESULT"] == 1 & df[z, "PTS_TYPE"] == 2){
    distance2 <- c(distance2, df[z, "CLOSE_DEF_DIST"])
    players2 <- c(players2, as.character(df[z, "player_name"]))
  }
}

#combine 2 point players and defender distance
player2point <- data.frame(players2, distance2)
summary(player2point)

#count players who scored 2 points
counter <- as.data.frame(table(players2))

#count 5 top players
top5Players2 <- counter[rev(order(counter$Freq)), "players2"][1:5]
top5Counter <- counter[rev(order(counter$Freq)), "Freq"][1:5]

top5_2points <- data.frame(top5players2, top5Counter)

#plot the graph
library(ggplot2)
ggplot(data = top5_2points, aes(x = top5Players2)) +
  geom_bar(aes(x = top5players2, y = top5Counter), stat = "identity")

#----------------------------------------------------------------#

#select distance data from 3 points shot scored and the players who scored it
distance3 <- c()
players3 <- c()
for (z in 1:nrow(df)){
  if(df[z, "SHOT_RESULT"] == 1 & df[z, "PTS_TYPE"] == 3){
    distance3 <- c(distance3, df[z, "CLOSE_DEF_DIST"])
    players3 <- c(players3, as.character(df[z, "player_name"]))
  }
}

#combine 3 point players and defender distance
player3point <- data.frame(players3, distance3)
summary(player3point)

#count players who scored 3 points
counter3 <- as.data.frame(table(players3))

#count 5 top players
top5Players3 <- counter3[rev(order(counter3$Freq)), "players3"][1:5]
top5Counter3 <- counter3[rev(order(counter3$Freq)), "Freq"][1:5]

top5_3points <- data.frame(top5Players3, top5Counter3)

#plot the graph
library(ggplot2)
ggplot(data = top5_3points, aes(x = top5Players3)) +
  geom_bar(aes(x = top5Players3, y = top5Counter3), stat = "identity")

```

```{r}
#Summary of total points
ptssum<- cast(df1, GAME_ID1+ player_id + player_name  ~ PTS); head(ptssum)
#creating "total points per player, per game" column
ptssum$totalpts<- ptssum[,"2"]*2 + ptssum[,"3"]*3

pttsum2<-ptssum[order(ptssum$totalpts,decreasing=TRUE),]
head(pttsum2,10)
```

```{r}
###Hot Hand Theory

#From 'FGM' column we have that 1 represents a basket made and 0 represents a basket missed
#Define the length of a shooting streak to be the number of consecutive baskets made until a miss occurs
#Create a function that gives us a vector with the number of total streaks(from all players and all games)
number_of_streaks <- function(x) {
  x <- c(0, x, 0)
  which_zero <- which(x == 0)
  streak <- diff(which_zero) - 1
  streak
}

number_of_streaks(df$FGM)

#Set a new data frame for the 5 players with best performances(higher points)
best_players_df <- head(pttsum2,5)

#Create a function that gives us a vector of streaks for a specific player and game
player_and_game <- function(x, y) {
   player <- df[df[ ,'player_id'] == x & df[ ,'GAME_ID1'] == y, 'FGM']
   number_of_streaks(as.vector(player))
}
#For the first player and game try:
#player_and_game('202681', '21400681')


#Create a list that gives us the streaks of each player and game (5 best performances)
streak_per_player <- list()
j <- 1
for(i in best_players_df$player_id) {
   streak_per_player[[j]] <- player_and_game(i, best_players_df[ourtable[ ,'player_id'] == i, 'GAME_ID1'])
   j <- j + 1
}
streak_per_player

<<<<<<< HEAD
=======
#Create a data frame for the strikes of each one of the 10 players (cannot create a data frame including all of them, because each list has different length)
player1_df <- data.frame('streaks' = streak_per_player[[1]])
player2_df <- data.frame('streaks' = streak_per_player[[2]])
player3_df <- data.frame('streaks' = streak_per_player[[3]])
player4_df <- data.frame('streaks' = streak_per_player[[4]])
player5_df <- data.frame('streaks' = streak_per_player[[5]])

#Show distribution for each player's streak lengths
ggplot(data = player1_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = ourtable[1,'player_name'])
ggplot(data = player2_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = ourtable[2,'player_name'])
ggplot(data = player3_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = ourtable[3,'player_name'])
ggplot(data = player4_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = ourtable[4,'player_name'])
ggplot(data = player5_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = ourtable[5,'player_name'])

#Create a boxplot for each player's streak lengths
boxplot(player1_df$streaks) 
summary(player1_df$streaks) #Check that boxplot is valid
IQR(player1_df$streaks) #Check that boxplot is valid
#The typical length of a streak is 0 (median = 0) - The Interquartile Range is 1 - Streak lengths of 3 and 6 are unusually high compared to the rest of the distribution
boxplot(player2_df$streaks)
summary(player2_df$streaks)
IQR(player2_df$streaks)
#The typical length of a streak is 1 (median = 1) - The Interquartile Range is 2 - There are some high streak lengths (max = 4)
boxplot(player3_df$streaks)
summary(player3_df$streaks)
IQR(player3_df$streaks)
#The typical length of a streak is 0 (median = 0) - The Interquartile Range is 0 - Streak lengths of 3 and 13 (!!!) are unusually high compared to the rest of the distribution
boxplot(player4_df$streaks)
summary(player4_df$streaks)
IQR(player4_df$streaks)
#The typical length of a streak is 1 (median = 1) - The Interquartile Range is 2 - Streak length of 6 is unusually high compared to the rest of the distribution
boxplot(player5_df$streaks)
summary(player5_df$streaks)
IQR(player5_df$streaks)
#The typical length of a streak is 1 (median = 1) - The Interquartile Range is 2 - There are some high streak lengths (max = 5)

#We can see that the distribution of all players is right skewed and that all of them (especially player3) have some long shooting streaks. To prove/disprove the hot hand theory we need to examine the indipendence of the shots. If each shot that a player takes is independent of the next shot, then a missed/made shot will not affect the propability that the next shot will be missed/made. So, if consecutive shots are independent, we disprove hot hand theory, while if consecutive shots are dependent, we prove the hot hand theory.
#Simulation - create a vector of shots('made', 'missed') for a sample shooter
set.seed(23)
shot_results <- c('made', 'missed')
simul_shooter <- sample(shot_results, size = nrow(player1_df), replace = TRUE, prob = c(0.45, 0.55))
simul_shooter

#Set 1 for baskets made and 0 for baskets missed
simul_shooter <- as.list(simul_shooter)
for(i in 1:length(simul_shooter)) {
   if(simul_shooter[i] == 'made') simul_shooter[i] <- 1
   else if(simul_shooter[i] == 'missed') simul_shooter[i] <- 0
}
simul_shooter

#Use previous function (number_of_streaks) to calculate the streaks made by the sample shooter 
streaks_of_simulshooter <- number_of_streaks(simul_shooter)
simulshooter_df <- data.frame('streaks' = streaks_of_simulshooter)

#Comparisons of data between sample shooter and real shooters
summary(streaks_of_simulshooter)
summary(player1_df$streaks)

#Compare barplots of sample shooter and real shooter1
#If real shooter's streaks diverge significantly from an independent shooter's streaks(sample shooter's streaks), we can conclude tha the real shooter has a 'hot hand'. 
ggplot(data = simulshooter_df, aes(x = streaks)) + geom_bar() 
ggplot(data = player1_df, aes(x = streaks)) + geom_bar()
#
```

```{r}
#Regression Analysis

df1$GAME_CLOCK <-as.numeric(df1$GAME_CLOCK)

df1$AWAY_TEAM <- as.character(df1$AWAY_TEAM)

linreg_fgm <-lm(FGM ~ LOCATION+W+FINAL_MARGIN+SHOT_NUMBER+ PERIOD+GAME_CLOCK+  SHOT_CLOCK+  DRIBBLES+ TOUCH_TIME+SHOT_DIST+PTS_TYPE+ CLOSEST_DEFENDER_PLAYER_ID + CLOSE_DEF_DIST+ player_id+ WINNER, df1 )

summary(linreg_fgm)

linreg_fgm2 <-lm(FGM ~ FINAL_MARGIN+SHOT_NUMBER+ PERIOD +  SHOT_CLOCK+  DRIBBLES+ TOUCH_TIME+SHOT_DIST+PTS_TYPE+ CLOSE_DEF_DIST+ player_id, df1 )


summary(linreg_fgm2)




```


###Discussion
I   What results did you find?

I   Why is this interesting?

I   What would be the next steps?
---

```{r setup, include=FALSE}
>>>>>>> a80106d2b5b1471987f10907dbb273f0ce271dd8
knitr::opts_chunk$set(echo = TRUE)
```
Justin Leiendecker, Alexander Romanenko, Artmeis Tomadaki-Balomenou, Zijun Wei, Reza Widodo  
 

#Report structure 

###Introduction
I   What is your theme or research question?
a. Hot Hand Theory
b. Defender Proximity Analysis
c. Shot Clock Pressure
d. Close Game Effect - Small Margin affecting the scoring rate
e. Home Advantage
f. Fatigue Effect (Quarter Heat Rate)
g. Shooting Percentage
h. Fatigue Effect (Number of Rest Day)
i. 

###Theory
I   What do you expect to find?
a. 

###Methods
I   Describe the dataset:

Data on shots taken during the 2014-2015 season, who took the shot, where on the floor was the shot taken from, who was the nearest defender, how far away was the nearest defender, time on the shot clock, and much more. The column titles are generally self-explanatory.
Useful for evaluating who the best shooter is, who the best defender is, the hot-hand hypothesis, etc.
Scraped from NBA's REST API.  ##TO BE UPDATED FURTHER

I   Strengths

I   Limitations

###Analysis

###Discussion
I   What results did you find?

I   Why is this interesting?

I   What would be the next steps?