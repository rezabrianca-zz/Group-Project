---
title: "MSF_Groupwork-NBA_shotlog" 
author: "Team_9"
output: html_document  ---
  title: "MSF_Groupwork-NBA_shotlog"
author: "Team_9"
output: html_document 
---
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Justin Leiendecker, Alexander Romanenko, Artmeis Tomadaki-Balomenou, Zijun Wei, Reza Widodo  


#Report structure 

###Introduction
I   What is your theme or research question?
a. Hot Hand Theory (Artemis)
b. Defender Proximity Analysis (Reza)
c. Shot Clock Pressure  (Alex)
d. Close Game Effect - Small Margin affecting the scoring rate  
e. Home Advantage (Alex is working in this point)  
f. Fatigue Effect (Quarter Heat Rate)  
g. Shooting Percentage (James)
h. Fatigue Effect (Number of Rest Day)  
i. 

###Theory
I   What do you expect to find?
a. 

###Methods
I   Describe the dataset:
  
  Data on shots taken during the 2014-2015 season, who took the shot, where on the floor was the shot taken from, who was the nearest defender, how far away was the nearest defender, time on the shot clock, and much more. The column titles are generally self-explanatory.
Useful for evaluating who the best shooter is, who the best defender is, the hot-hand hypothesis, etc.
Scraped from NBA's REST API.  ##TO BE UPDATED FURTHER

I   Strengths

I   Limitations

###Analysis

##Installing packages and calling libraries
```{r}
install.packages('reshape')
library(reshape)
library(ggplot2)

```


###Data clean-up 

```{r}
df<- read.csv("shot_logs.csv")  #assigning the dataframe to 'df' variables
attach(df) #telling R that this is the dataframe we'll be working with (eliminating the need to use df$ for variables)

#we need to change the format of some of the columns to 'Character'

```
### Home Advantage analysis
```{r}
# replacing W/L in column "W" with 1/0 (1 for win, 0 for loss)
df[,"W"] <- as.character(df[,"W"])

for (i in 1:nrow(df)) {
  if (df[i,"W"]=="W") df[i,"W"]<- 1
  if (df[i,"W"]=="L") df[i,"W"]<- 0}

df[,"W"] <- as.numeric(df[,"W"])
```

```{r}
#adding columns for names of 'home' and 'away' teams. In addition, WINNER column tells which team won
df[,"MATCHUP"] <- as.character(df[,"MATCHUP"])
df[,"W"] <- as.character(df[,"W"])

for (i in 1:nrow(df)) {
  if (LOCATION[i]=="H") {df$HOME_TEAM [i] <- unlist(strsplit(df$MATCHUP[i]," "))[5]
  df$AWAY_TEAM [i] <- unlist(strsplit(df$MATCHUP[i]," "))[7]
  if (W[i]=="W") df$WINNER[i] <- "HOME" 
  if (W[i]=="L") df$WINNER[i] <- "AWAY"}
  if (LOCATION[i]=="A") {df$HOME_TEAM [i] <- unlist(strsplit(df$MATCHUP[i]," "))[7] 
  df$AWAY_TEAM [i] <- unlist(strsplit(df$MATCHUP[i]," "))[5]
  if (W[i]=="L") df$WINNER[i] <- "HOME"  
  if (W[i]=="W") df$WINNER[i] <- "AWAY"}}

df$BLANK<-"" #for some reason cast function does not work with last column in dataframe, so I have created this BLANK column as I need to use AWAY_TEAM colum (it was a last column). 
```

```{r}
aa<- cast(df1, GAME_ID1 + HOME_TEAM + AWAY_TEAM + WINNER ~ W)

table(aa$WINNER) [2]
#home wins:
hh<-sum(aa$WINNER=="HOME")
#Away wins:
aw<-sum(aa$WINNER=="AWAY")
#percentage of home team winning: 
round(hh/(hh+aw),2)
```

```{r}
head(aa)
aa1<- cast(aa, HOME_TEAM  ~ WINNER); names(aa1)[1]<-"TEAM"
aa1$WIN_PCT_HOME<-round(aa1$HOME/(aa1$HOME+aa1$AWAY),2)

aa2<- cast(aa, AWAY_TEAM ~ WINNER); names(aa2)[1]<-"TEAM"
aa2$WIN_PCT_AWAY<-round(aa2$AWAY/(aa2$HOME+aa2$AWAY),2)

aa3<- merge (aa1,aa2, by ="TEAM")


for (i in 1:nrow(aa3)) {if(aa3$WIN_PCT_HOME[i]>aa3$WIN_PCT_AWAY[i]) aa3$HOME_ADV[i]<-"YES" else aa3$HOME_ADV[i]<-"NO"}
head(aa3)

aa3<- aa3[order(aa3$WIN_PCT_HOME,decreasing=TRUE),]
rownames(aa4)<-NULL

aa3$TEAM <- factor(aa5$TEAM, levels = aa5$TEAM[order(-aa5$WIN_PCT_HOME)])


ggplot(aa3,aes(x=TEAM)) + geom_point(aes(y= WIN_PCT_HOME, col= "HOME"))+ geom_point(aes( y= WIN_PCT_AWAY, col= "AWAY")) 
#TO BE UPDATED  
```

# Shooting Percentage Analysis (James)

```{r}
# Replace "made" and "missed" with 1 and 0 respectively

df[, "SHOT_RESULT"] <- as.character(df[, "SHOT_RESULT"])
 
for (i in 1:nrow(df)) {
  if (df[i, "SHOT_RESULT"] == "made") df[i, "SHOT_RESULT"] <- 1
  if (df[i, "SHOT_RESULT"] == "missed") df[i, "SHOT_RESULT"] <- 0
}

df[, "SHOT_RESULT"] <- as.numeric(df[, "SHOT_RESULT"])

```

# 

```{r}
# Find shooting percentage of each match

# Trying to reshape...

library(reshape)
game <- cast(data = df, GAME_ID1 ~ SHOT_RESULT)
View(game)

# 

Team <- rep(NA, (lastGamesID - firstGamesID + 1) * 2)
FG_Percentage <- rep(NA, (lastGamesID - firstGamesID + 1) * 2)
for(i in 21400001:21400908){
  j = i - 21400001 +1 # 
  game <- df[, df[, "GAME_ID1"] == i]
  home <- game[, game["LOCATION"] == "H"]
  home.p <- count(home[, home[, "SHOT_RESULT"] == 1]) / nrow(home)
  away <- game[, game["LOCATION"] == "A"]
  away.p <- count(home[, home[, "SHOT_RESULT"] == 1]) / away(home)
  FG_Percentage[j] <- home.p
  FG_Percentage[j + 1] = away.p
  Team[j] = "H"
  Team[j + 1] = "A"
}



```


###Defender Proximity Analysis
```{r}
#Data Preparation
#Change the value of shot result column to numeric
df[, "SHOT_RESULT"] <- as.character(df[, "SHOT_RESULT"])
for (j in 1:nrow(df)){
  df[j, "SHOT_RESULT"] <- ifelse (df[j, "SHOT_RESULT"] == "made", 1, 0)
}

#set the value to numeric or integer accordingly
df[, "SHOT_RESULT"] <- as.numeric(df[, "SHOT_RESULT"])
df[, "PTS_TYPE"] <- as.integer(df[, "PTS_TYPE"])
df[, "CLOSE_DEF_DIS"] <- as.numeric(df[, "CLOSE_DEF_DIST"])

#select data with only scored result
#Point type (2 or 3 points) and distance
point_type <- c()
distance <- c()
for (z in 1:nrow(df)){
  if(df[z, "SHOT_RESULT"] == 1 & df[z, "PTS_TYPE"] >= 1){
    point_type <- c(point_type, df[z, "PTS_TYPE"])
    distance <- c(distance, df[z, "CLOSE_DEF_DIST"])
  }
}

#combine point type and distance
valid_distance = data.frame(point_type, distance)

#calculate correlation between defender distance and points made (2 or 3 points)
cor(point_type, distance)

#plot the diagram for this correlation
library(ggplot2)
ggplot(data = valid_distance, aes(x = point_type, y = distance, group = point_type)) + 
  geom_boxplot() + stat_summary(fun.y = mean, geom = "point", shape = 5, size = 1) + 
  ggtitle("Points Scored based on Distance from Defender")

#calculate correlation between defender distance and shot result
cor(df[, "SHOT_RESULT"], df[, "CLOSE_DEF_DIS"])

#--------------------------------------------------------------------------------#

#Further analysis
#select distance data from 2 points shot scored and the players who scored it
distance2 <- c()
players2 <- c()
for (z in 1:nrow(df)){
  if(df[z, "SHOT_RESULT"] == 1 & df[z, "PTS_TYPE"] == 2){
    distance2 <- c(distance2, df[z, "CLOSE_DEF_DIST"])
    players2 <- c(players2, as.character(df[z, "player_name"]))
  }
}

#combine 2 point players and defender distance
player2point <- data.frame(players2, distance2)
summary(player2point)

#count players who scored 2 points
counter <- as.data.frame(table(players2))

#count 5 top players
top5Players2 <- counter[rev(order(counter$Freq)), "players2"][1:5]
top5Counter <- counter[rev(order(counter$Freq)), "Freq"][1:5]

top5_2points <- data.frame(top5players2, top5Counter)

#plot the graph
library(ggplot2)
ggplot(data = top5_2points, aes(x = top5Players2)) +
  geom_bar(aes(x = top5players2, y = top5Counter), stat = "identity")

#----------------------------------------------------------------#

#select distance data from 3 points shot scored and the players who scored it
distance3 <- c()
players3 <- c()
for (z in 1:nrow(df)){
  if(df[z, "SHOT_RESULT"] == 1 & df[z, "PTS_TYPE"] == 3){
    distance3 <- c(distance3, df[z, "CLOSE_DEF_DIST"])
    players3 <- c(players3, as.character(df[z, "player_name"]))
  }
}

#combine 3 point players and defender distance
player3point <- data.frame(players3, distance3)
summary(player3point)

#count players who scored 3 points
counter3 <- as.data.frame(table(players3))

#count 5 top players
top5Players3 <- counter3[rev(order(counter3$Freq)), "players3"][1:5]
top5Counter3 <- counter3[rev(order(counter3$Freq)), "Freq"][1:5]

top5_3points <- data.frame(top5Players3, top5Counter3)

#plot the graph
library(ggplot2)
ggplot(data = top5_3points, aes(x = top5Players3)) +
  geom_bar(aes(x = top5Players3, y = top5Counter3), stat = "identity")

```

```{r}
#Summary of total points
ptssum<- cast(df1, GAME_ID1+ player_id + player_name  ~ PTS); head(ptssum)
#creating "total points per player, per game" column
ptssum$totalpts<- ptssum[,"2"]*2 + ptssum[,"3"]*3

pttsum2<-ptssum[order(ptssum$totalpts,decreasing=TRUE),]
head(pttsum2,10)
```

```{r}
###Hot Hand Theory

#Set the value to character
df[, "SHOT_RESULT"] <- as.character(df[, "SHOT_RESULT"])

#Define 1 for baskets made and 0 for baskets missed. We need a vector to use it to our function below.
shotresult <- c()
for(i in 1:nrow(df)) {
  if(shots[i] == 'missed') shotresult <- c(shotresult, 0)
  else if(shots[i] == 'made') shotresult <- c(shotresult, 1)
}

shotresult

#Set the value to numeric/integer
df[, "SHOT_RESULT"] <- as.numeric(df[, "SHOT_RESULT"])
df[ ,'SHOT_NUMBER'] <- as.integer(df[ , 'SHOT_NUMBER'])

#Define the length of a shooting streak to be the number of consecutive baskets made until a miss occurs
#Create a function that gives us a vector with the number of streaks
number_of_streaks <- function(x) {
  x <- c(0, x, 0)
  which_zero <- which(x == 0)
  streak <- diff(which_zero) - 1
  streak
}

number_of_streaks(shotresult)

#Create a function that gives us a vector of streaks for a specific player and game
player_and_game <- function(x, y) {
   player <- df[df[ ,'player_id'] == x & df[ ,'GAME_ID1'] == y, 'FGM']
   number_of_streaks(as.vector(player))
}
player_and_game(202681, 21400681)

ourtable <- head(pttsum2,10)

#Create a list that gives us the streaks of each player and game (10 best performances)
streak_per_player <- list()
j <- 1
for(i in ourtable$player_id) {
   streak_per_player[[j]] <- player_and_game(i, ourtable[ourtable[ ,'player_id'] == i, 'GAME_ID1'])
   j <- j + 1
}
streak_per_player

#Create a data frame for the strikes of each one of the 10 players (cannot create a data.frame including all of them, because each list has different length)
player1_df <- data.frame('streaks' = streak_per_player[[1]])
player2_df <- data.frame('streaks' = streak_per_player[[2]])
player3_df <- data.frame('streaks' = streak_per_player[[3]])
player4_df <- data.frame('streaks' = streak_per_player[[4]])
player5_df <- data.frame('streaks' = streak_per_player[[5]])
player6_df <- data.frame('streaks' = streak_per_player[[6]])
player7_df <- data.frame('streaks' = streak_per_player[[7]])
player8_df <- data.frame('streaks' = streak_per_player[[8]])
player9_df <- data.frame('streaks' = streak_per_player[[9]])
player10_df <- data.frame('streaks' = streak_per_player[[10]])
ourtable

#Visualisation for 10 players
ggplot(data = player1_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = 'Kyrie Irving')
ggplot(data = player1_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = 'Kyrie Irving')
ggplot(data = player1_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = 'Kyrie Irving')
ggplot(data = player1_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = 'Kyrie Irving')
ggplot(data = player1_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = 'Kyrie Irving')
ggplot(data = player1_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = 'Kyrie Irving')
ggplot(data = player1_df, aes(x = streaks)) + geom_histogram(binwidth = 1) + labs(title = 'Kyrie Irving')

###Discussion
I   What results did you find?

I   Why is this interesting?

I   What would be the next steps?
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
Justin Leiendecker, Alexander Romanenko, Artmeis Tomadaki-Balomenou, Zijun Wei, Reza Widodo  
 

#Report structure 

###Introduction
I   What is your theme or research question?
a. Hot Hand Theory
b. Defender Proximity Analysis
c. Shot Clock Pressure
d. Close Game Effect - Small Margin affecting the scoring rate
e. Home Advantage
f. Fatigue Effect (Quarter Heat Rate)
g. Shooting Percentage
h. Fatigue Effect (Number of Rest Day)
i. 

###Theory
I   What do you expect to find?
a. 

###Methods
I   Describe the dataset:

Data on shots taken during the 2014-2015 season, who took the shot, where on the floor was the shot taken from, who was the nearest defender, how far away was the nearest defender, time on the shot clock, and much more. The column titles are generally self-explanatory.
Useful for evaluating who the best shooter is, who the best defender is, the hot-hand hypothesis, etc.
Scraped from NBA's REST API.  ##TO BE UPDATED FURTHER

I   Strengths

I   Limitations

###Analysis

###Discussion
I   What results did you find?

I   Why is this interesting?

I   What would be the next steps?